#!/usr/bin/env bash

# Exit if any command fails
set -eo pipefail

RELEASE_VERSION=$1
FILENAME_PREFIX="Plugin_PrestaShop_"
FOLDER_PREFIX="multisafepayofficial"
RELEASE_FOLDER=".dist"

# If tag is not supplied, latest tag is used
if [ -z "$RELEASE_VERSION" ]
then
  RELEASE_VERSION=$(git describe --tags --abbrev=0)
fi

# Store script directory before changing directories
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Remove old folder
rm -rf "$RELEASE_FOLDER"

# Create release
mkdir "$RELEASE_FOLDER"
git archive --format zip -9 --prefix="$FOLDER_PREFIX"/ --output "$RELEASE_FOLDER"/"$FILENAME_PREFIX""$RELEASE_VERSION".zip "$RELEASE_VERSION"

# Unzip to download dependencies
cd "$RELEASE_FOLDER"
unzip "$FILENAME_PREFIX""$RELEASE_VERSION".zip

# Remove the archive zip file
rm "$FILENAME_PREFIX""$RELEASE_VERSION".zip

# Remove all the .gitkeep files
rm "$FOLDER_PREFIX"/*/.gitkeep

# Install composer with dev dependencies
composer install --working-dir="$FOLDER_PREFIX" --no-interaction --no-scripts

# Override the autoindex template with the license header required by PrestaShop
if [ -d "$FOLDER_PREFIX/vendor/prestashop/autoindex/assets" ]; then
  cp "$SCRIPT_DIR/index_template.txt" "$FOLDER_PREFIX/vendor/prestashop/autoindex/assets/index.php"
fi

# Generate index.php files in all necessary folders
cd "$FOLDER_PREFIX"
vendor/bin/autoindex --exclude=vendor

# Create index.php files in the main directory because is not being generated by autoindex
if [ ! -f "$FOLDER_PREFIX/index.php" ]; then
  cp "$SCRIPT_DIR/index_template.txt" "./index.php"
fi

cd ..

# Update composer dependencies to uninstall dev dependencies
composer update --no-dev --working-dir="$FOLDER_PREFIX" --no-interaction --no-scripts

# Zip everything
zip -9 -r "$FILENAME_PREFIX""$RELEASE_VERSION".zip "$FOLDER_PREFIX" -x "$FOLDER_PREFIX""/composer.json" -x "$FOLDER_PREFIX""/composer.lock" -x "$FOLDER_PREFIX""/grumphp.yml"
